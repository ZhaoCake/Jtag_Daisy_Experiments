# OpenOCD configuration for dual-JTAG daisy chain simulation

adapter driver remote_bitbang
remote_bitbang host localhost
remote_bitbang port 9823

# Define the TAPs
# Note: OpenOCD scans data from TDO to TDI. 
# The device closest to TDO shifts out its IDCODE first.

# TAP 2 (Closest to TDO)
# IDCODE observed: 0x2e200a6d
# IrLength: 5 (from dmi_jtag_tap.sv)
jtag newtap tap2 tap -irlen 5 -expected-id 0x2e200a6d

# TAP 1 (Closest to TDI)
# IDCODE observed: 0x1e200a6d
# IrLength: 5 (from dmi_jtag_tap.sv)
jtag newtap tap1 tap -irlen 5 -expected-id 0x1e200a6d

# Define the targets
# Each TAP corresponds to a Debug Transport Module (DTM) for a RISC-V core (or cluster).

# Target for TAP 2
target create core2 riscv -chain-position tap2.tap -coreid 0

# Target for TAP 1
target create core1 riscv -chain-position tap1.tap -coreid 0

# Initialize
init

# Increase timeout for simulation (slower than real hardware)
riscv set_command_timeout_sec 120

# Use System Bus Access for memory operations instead of program buffer
# This avoids issues with program buffer execution
riscv set_mem_access sysbus

# Scan the chain to verify
scan_chain

# Halt both cores first to prevent running garbage instructions
echo "Halting all cores..."
targets core1
halt
targets core2
halt

# Load test program to both cores (if sw/test.bin exists)
# This prevents "Hart unexpectedly reset" warnings from running invalid instructions
echo "Loading test program..."
targets core1
load_image sw/test.bin 0x00100000 bin
reg pc 0x00100000
targets core2
load_image sw/test.bin 0x00100000 bin
reg pc 0x00100000

# Display information about the targets
echo "Target status:"
targets
